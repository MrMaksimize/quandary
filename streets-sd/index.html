<!DOCTYPE html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Behind the Scenes of StreetsSD</title><meta name=description content="StreetsSD was an interesting project us from an organizational and technical perspective.  Let&rsquo;s peek behind the scenes to see how this all came together."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=black-translucent><meta name=twitter:card content="summary"><meta name=twitter:site content="@MrMaksimize"><meta name=twitter:title content="Behind the Scenes of StreetsSD"><meta name=twitter:image content="http://quandary.io/assets/images/logo_white.png"><meta name=twitter:description content="StreetsSD was an interesting project us from an organizational and technical perspective.  Let&rsquo;s peek behind the scenes to see how this all came together."><meta property=og:site_name content="Quandary."><meta property=og:title content="Behind the Scenes of StreetsSD"><meta property=og:description content="StreetsSD was an interesting project us from an organizational and technical perspective.  Let&rsquo;s peek behind the scenes to see how this all came together."><meta property=og:image content="http://quandary.io/assets/images/sdstreets_outline.jpg"><meta property=og:url content="http://quandary.io/streets-sd/"><meta property=og:type content="blog"><meta property=article:published_time content=2016-11-01T00:00:00+00:00><link rel=canonical href="http://quandary.io/streets-sd/"><link rel="shortcut icon" href=/assets/images/favicon.png type="image/png"><link rel=stylesheet href=//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i><link href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css rel=stylesheet><link href="//fonts.googleapis.com/css?family=Merriweather" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=/atom.xml><link rel=stylesheet type=text/css media=screen href="/css/main.css"><link rel=stylesheet type=text/css media=print href="/css/print.css"></head><body itemscope itemtype=http://schema.org/Article><a href="/" class=logo-readium><span class=logo style="background-image: url(/assets/images/logo_white.png)"></span></a><main class=content role=main><article class=post><div class=article-image><div class=post-image-image style="background-image: url(/assets/images/sdstreets_outline.jpg)">Article Image</div><div class=post-image-image2 style="background-image: url()">Article Image</div><div class=post-meta><h1 class=post-title>Behind the Scenes of StreetsSD</h1><div class="cf post-meta-text"><div class=author-image style="background-image: url(/assets/images/author.jpg)">Blog Logo</div><h4 class=author-name itemprop=author itemscope itemtype=http://schema.org/Person>Maksim Pecherskiy</h4>on <time datetime="2016-11-01 00:00">01 Nov 2016</time></div><div style=text-align:center><a href=#topofpage class=topofpage><i class="fa fa-angle-down"></i></a></div></div></div><section class=post-content><div class=post-reading><span class=post-reading-time></span> read</div><a name=topofpage></a><p><a href=http://streets.sandiego.gov>StreetsSD</a> was an interesting project us from an organizational and technical perspective. Let&rsquo;s peek behind the scenes to see how this all came together.</p><h1>Overall Architecture</h1><h2>Jekyll</h2><p>Overall, <a href=http://streets.sandiego.gov>StreetsSD</a> is a <a href="https://jekyllrb.com/">Jekyll</a> site. This allows us to avoid maintenance costs, performance issues, and complexity associated with running database-driven sites. We host it using Github Pages for the wonderful price of $0.</p><p><img src=/assets/images/sdstreets_outline.jpg alt="Jekyll Outline"></p><p>Everything you see outlined in pink above is Jekyll and custom JS. We used the <a href=www.sandiego.gov/communications/design/index.shtml>San Diego Style Guide</a> for colors and layouts. The charts on the bottom, the layers, and the text in the explainer boxes are controlled by the <a href=https://github.com/cityofsandiego/streetsSD/blob/master/src/_data/views.yml>views.yml</a> in the repo.</p><p>All the dynamic components you see from the layers (FY14, FY15, etc) to the charts and totals are populated through custom SQL queries against data in Carto. They are constructed using the <a href="https://hiddentao.com/squel/">squel library</a> in the <a href=https://github.com/cityofsandiego/streetsSD/blob/master/src/assets/javascript/sqlBuilder.js>sqlBuilder</a> file.</p><p>As an example, when you click on the &ldquo;Work in FY-2016&rdquo; layer, an event is sent that constructs and sends the query to Carto to display results on a map. Based on the <a href=https://github.com/cityofsandiego/streetsSD/blob/master/src/_data/views.yml>views.yml</a> file, we know that layer has WorkType and WorkByMonth charts, so one more query is constructed and sent to Carto. After additional JS data processing, we are able to display the charts.</p><h2>Carto</h2><p>The interactive map itself is all Carto. Most of the visual components (e.g. line styles, legends, hovers) are stored in Carto as well. We don&rsquo;t love that, because those should be stored in code, but we have an issue on the backlog to address it.</p><p><img src=/assets/images/carto_editor.jpg alt="Carto editor"></p><p>The map in Carto has two &ldquo;layers&rdquo; - one for OCI and one for Streetwork, both based off <code>sdstreets_query</code> table. Carto&rsquo;s model for associating layers to datasets ties them together permanently. By having a virtual dataset that we can impose queries on, we are eliminating the tie between a dataset and a map, giving us more flexibility to flip out the underlying datasets if we need to change schemas.</p><p>Then why two layers from one table? Because OCI layers and streetwork layers have slightly different fields and labels. Carto&rsquo;s interactive UI is tied to a layer, and we had to separate the two. Then, we impose the queries on the layer accordingly. We can probably condense this to one layer using more advanced conditional logic, but we&rsquo;ll stay away from that for now.</p><h2>Deployment</h2><p>We use the <code>master</code> branch as the bleeding edge. That gets deployed to a staging site continuously by CircleCI. The <code>production</code> branch gets deployed to the <code>gh-pages</code> branch, which is what feeds <a href=http://streets.sandiego.gov>StreetsSD</a>. We get notifications about each step.</p><h2>Datasets</h2><h5><code>cg_streets_combined</code></h5><p>We created this dataset by merging the City&rsquo;s official street file geographies with essential data from the City&rsquo;s Pavement Management System. Every other set of data is joined against <code>cg_streets_combined</code> by <code>segment_id</code> to derive the geometries and street names.</p><h5><code>sd_paving_datasd</code></h5><p>This is the full work layer, encompassing work done from the beginning of FY14. We&rsquo;ll talk about the specifics in the data delivery section. This has no geospatial data. As layers get selected, SQL is generated, applied to this layer, and joined against <code>cg_streets_combined</code>.</p><h5><code>oci_2011_datasd</code> and <code>oci_2015_datasd</code></h5><p>These were created using historical data provided in the Pavement Management System and the new OCI numbers we received from latest run of the most recent vendor. These also have no geospatial data. As layers get selected, SQL is generated, applied to this layer, and joined against <code>cg_streets_combined</code>.</p><h2>Data Discovery</h2><p>We partnered with the <a href=https://www.sandiego.gov/tsw>Transportation and Storm Water Department</a> to build the map. However, we quickly ran into some challenges with understanding the data, and the calculations performed for reporting.</p><p>The PVM (let&rsquo;s use that as the acronym for the Pavement Management System) is an application that is built on top of SQL server using queries and stored procedures. Every month, the streets team has to update IMCAT. IMCAT is a system the City uses to coordinate street work across departments. This way we can avoid the same segment being dug up multiple times in a short time span. The streets team pull a report from the PVM generated by a query and a stored procedure). Then, it&rsquo;s manually cleaned in Excel (we counted 32 steps), joined with a streets shapefile, and uploaded it to IMCAT.</p><p>This is where we started. The data that gets uploaded to IMCAT has to be in a particular format with certain columns, so we couldn&rsquo;t directly trace that dataset to the query running against PVM. And we couldn&rsquo;t just guess the query and match the result either - PVM has 319 tables.</p><p>A few months ago, the City invested in a tool called Alation exactly for this type of use case. We wanted to be able to maintain data catalogs and keep documentation on the data that we have, allowing data users to be better informed. This database is the first one we connected with Alation.</p><p>We built a robust query to continuously pull data. To do this, we used Alation to trace the query the PVM application was running. However, we had no visibility into the stored procedure. To bypass this, we combined information from using the query, the streets team and Alation&rsquo;s query logs.</p><h3>Query Log</h3><p><img src=/assets/images/alation_query_log.jpg alt="Query Log"></p><h3>Tables</h3><p><img src=/assets/images/alation_tables.jpg alt=Tables></p><h3>Table Internal View + Our Notes</h3><p><img src=/assets/images/alation_table_internal.jpg alt="Table Internal View + Our Notes"></p><h3>Built Query for Paving Data</h3><p><img src=/assets/images/built_query.jpg alt="Built Query for Paving Data"></p><h3>Built Query for Street Info</h3><p><img src=http://take.ms/r9EHi alt="Built Query for Street Info"></p><p>Going through this process gave us an enormous amount of knowledge of street paving information, which we have documented in Alation.</p><p>However, we weren&rsquo;t done yet. We still needed to build the ETL for Street Map Data, IMCAT data (because friends don&rsquo;t let friends clean data over and over manually), and the <code>CG_STREETS_COMBINED</code> file.</p><h2>Data Delivery</h2><p>We have two main queries that pull data without doing much cleaning. We wanted to stay away from cleaning in SQL as a best practice.</p><p><code>streets_base</code> gets pulled by FME, combined with the geospatial base file, and outputs as a shapefile to S3. Carto syncs it down from there:</p><p><img src=/assets/images/cg_fme.jpg alt="Streets Base ETL"></p><p>R pulls <code>Pavement Ex</code> in using Alation&rsquo;s API and the <a href=https://github.com/mattwg/alation>Alation R Package</a>, completes the 32 manual steps the department normally has to do (with some conditional forks for IMCAT), and then outputs the <code>sd_paving_datasd.csv</code> file into S3. We also make sure to standardize the outgoing data according to our <a href=https://datasd.gitbooks.io/open-data-implementation-update-2016/content/main/technical-guidelines.html>Technical Guidelines</a>. At the same time, we output the IMCAT file to be ingested for the conflict mitigation map.</p><h2>Verifying Calculations</h2><p>So, how in the world do we know that our constructed SQL on the client side is doing the right thing and making the right calculations? We use R to verify that the calculations are correct by pulling the data straight from Alation, and duplicating the calculations that the SQL does on Streets Map.</p><h1>What&rsquo;s next?</h1><p>This is an alpha project, and we plan to continue working on it. We will work in sprints As people submit feature or bug requests, we will prioritize them according to what we think we can do during the time allotted. Critical bugs always get fixed first.</p><p>Of course, we are more than open to Pull Requests. If there is a feature you really want and we&rsquo;re just unable to get to it, feel free to discuss it with us in the <a href=https://github.com/cityofsandiego/streetsSD/issues>issue queues</a>, fork the code, and make a Pull Request.</p></section><footer class=post-footer><section class=share></section></footer><div class="bottom-teaser cf"><div class=isLeft><h5 class="index-headline featured"><span>Written by</span></h5><section class=author><div class=author-image style="background-image: url(/assets/images/author.jpg)">Blog Logo</div><h4>Maksim Pecherskiy</h4><p class=bio></p><hr><p class=published>Published <time datetime="2016-11-01 00:00">01 Nov 2016</time></p></section></div><div class=isRight><h5 class="index-headline featured"><span>Supported by</span></h5><footer class=site-footer><section class=poweredby>Proudly published with <a href=http://jekyllrb.com>Jekyll</a></section><a class=subscribe href=/feed.xml><span class=tooltip><i class="fa fa-rss"></i> You should subscribe to my feed.</span></a><div class=inner><section class=copyright>All content copyright <a href="/">Maksim Pecherskiy</a> &copy; 2017<br>All rights reserved.</section></div></footer></div></div></article></main><div class=bottom-closer><div class=background-closer-image style="background-image: url(/assets/images/harddrive.jpg)">Image</div><div class=inner><h1 class=blog-title>Quandary.</h1><h2 class=blog-description>An Experiment</h2><a href="/" class=btn>Back to Overview</a></div></div><script src=https://code.jquery.com/jquery-1.11.1.min.js></script><script type=text/javascript src=/assets/js/jquery.fitvids.js></script><script type=text/javascript src=/assets/js/index.js></script><script type=text/javascript src=/assets/js/readingTime.min.js></script><script>(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));</script></body></html>